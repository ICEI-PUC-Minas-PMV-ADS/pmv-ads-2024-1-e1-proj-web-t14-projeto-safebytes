<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="../css/stylesheets.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script defer src="../js/perfil.js"></script>
    <script defer src="../js/historico.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

    <title>Perfil | Vigia Virtual</title>
</head>

<body id="pagPerfil">
    <header>
        <!-- Imagem de Fundo -->
        <div id="bg04div">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 810 320">
                <path fill="#325CC8" fill-opacity="1"
                    d="M0,64L48,101.3C96,139,192,213,288,245.3C384,277,480,267,576,218.7C672,171,768,85,864,48C960,11,1056,21,1152,32C1248,43,1344,53,1392,58.7L1440,64L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z">
                </path>
            </svg>
        </div>

        <!-- Foto de perfil -->
        <div class="foto">
            <img id="perfil" src="../assets/perfil.jpg" alt="Foto de perfil">
        </div>

        <div class="setaVoltar">
            <i id="seta-voltar" class="bi bi-chevron-compact-left"></i>
        </div>
    </header>

    <!-- Nickname -->
    <span id="caixa-branca">
        <div class="nick-box">
            <div class="nickname">
                <h6 id="userNickname">Nickname</h6>
            </div>
        </div>
    </span>

    <!-- Opções de Configuração -->
    <section id="perfilOptions">
        <div class="container">
            <div class="container-box">
                <div class="wrapper" id="configurarPerfil">
                    <div class="icon">
                        <i class="bi bi-gear"></i>
                    </div>
                    <div class="opcao">
                        <h3>Configurar Perfil</h3>
                    </div>
                    <div class="linkIcon">
                        <a href="#">
                            <i class="bi bi-chevron-compact-right"></i>
                        </a>
                    </div>
                </div>
                <div class="wrapper">
                    <div class="icon">
                        <i class="bi bi-check2-square"></i>
                    </div>
                    <div class="opcao">
                        <h3>O que foi feito</h3>
                    </div>
                    <div class="linkIcon">
                        <a href="pagHistorico.html">
                            <i class="bi bi-chevron-compact-right"></i>
                        </a>
                    </div>
                </div>
                <div class="wrapper">
                    <div class="icon">
                        <i class="bi bi-mortarboard"></i>
                    </div>
                    <div class="opcao">
                        <h3>Certificado</h3>
                    </div>
                    <div class="linkIcon">
                        <a href="#" onclick="baixarCertificado(event)">
                            <i id="cadeadoIcon" class="bi bi-lock"></i>
                        </a>
                    </div>
                </div>
                <div class="wrapper" id="logoutButton">
                    <div class="icon">
                        <i class="bi bi-door-open"></i>
                    </div>
                    <div class="opcao">
                        <h3>Sair</h3>
                    </div>
                    <div class="linkIcon">
                        <a href="#">
                            <i class="bi bi-chevron-compact-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>
</body>
<script>         
let todasTarefasConcluidas = false; // Variável booleana para verificar se todas as tarefas estão concluídas

async function gerarCertificado(event) {
    try {
        event.preventDefault(); // Adicionando preventDefault aqui para evitar o comportamento padrão do evento
        console.log("Gerar Certificado chamado.");

        const loggedInUserEmail = localStorage.getItem('loggedInUserEmail');
        const users = JSON.parse(localStorage.getItem('users'));

        const user = users.find(u => u.email === loggedInUserEmail);
        const nome = user ? user.nome : 'Usuário';

        const url = '../assets/Certificado - Vigia Virtual.pdf';
        const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer());

        const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);

        const pages = pdfDoc.getPages();
        const primeiraPagina = pages[0];

        const { width, height } = primeiraPagina.getSize();
        const fontSize = 35;

        // Carregar a fonte Helvetica e medir a largura do texto
        const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
        const textWidthNome = font.widthOfTextAtSize(nome, fontSize);

        // Calcular a posição x centralizada para o nome
        const xNome = (width - textWidthNome) / 2;
        const yNome = height / 2;

        // Adicionar nome ao certificado
        primeiraPagina.drawText(nome, {
            x: xNome,
            y: yNome,
            size: fontSize,
            font: font,
            color: PDFLib.rgb(0, 0, 0)
        });

        // Adicionar data de emissão ao certificado
        const dataEmissao = new Date().toLocaleDateString('pt-BR'); // Exemplo de formato de data
        const textWidthData = font.widthOfTextAtSize(dataEmissao, 12); // Tamanho da fonte para a data
        const xData = (width - textWidthData) / 2;
        const yData = height / 4; // Posição aproximada 3/4 abaixo da página
        primeiraPagina.drawText(dataEmissao, {
            x: xData,
            y: yData,
            size: 12,
            font: font,
            color: PDFLib.rgb(0, 0, 0)
        });

        const pdfBytes = await pdfDoc.save();

        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'certificado.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch (error) {
        console.error('Erro ao gerar o certificado:', error);
    }
}

async function verificarConclusaoAtividades() {
    try {
        const totalProgresso = await total();
        const totalConcluidosProgresso = await totalConcluidos();

        todasTarefasConcluidas = totalConcluidosProgresso === totalProgresso;

        // Atualizar estado do cadeado
        const cadeadoIcon = document.getElementById('cadeadoIcon');
        if (todasTarefasConcluidas) {
            cadeadoIcon.classList.remove('bi-lock');
            cadeadoIcon.classList.add('bi-unlock');
        } else {
            cadeadoIcon.classList.remove('bi-unlock');
            cadeadoIcon.classList.add('bi-lock');
        }

        return todasTarefasConcluidas;
    } catch (error) {
        console.error('Erro ao verificar conclusão das atividades:', error);
        return false;
    }
}

async function baixarCertificado(event) {
    try {
        event.preventDefault(); // Adicionando preventDefault aqui

        const todasTarefasConcluidas = await verificarConclusaoAtividades();

        if (todasTarefasConcluidas) {
            // Gerar e baixar o certificado, passando o evento
            await gerarCertificado(event);
        } else {
            console.log('Ainda há tarefas não concluídas.');
            // Poderia mostrar uma mensagem ao usuário informando que ele precisa concluir todas as atividades.
        }
    } catch (error) {
        console.error('Erro ao baixar o certificado:', error);
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        const loggedInUserEmail = localStorage.getItem('loggedInUserEmail');
        if (!loggedInUserEmail) {
            throw new Error('Nenhum usuário logado!');
        }

        await atualizarBarraProgresso();
        await createArtCards();
        await createTutorialItem();
        await createQuizItem();

        const totalConcluidosProgresso = await totalConcluidos();

        if (totalConcluidosProgresso > 0) {
            const progressNullSec = document.querySelector('#historicoProgressNull');
            progressNullSec.style.display = 'none';

            const artigosSec = document.querySelector('#historicoArtigosSec');
            artigosSec.style.display = 'block';

            const tutoriaisSec = document.querySelector('#historicoTutoriaisSec');
            tutoriaisSec.style.display = 'block';

            const quizzesSec = document.querySelector('#historicoQuizzesSec');
            quizzesSec.style.display = 'block';
        }

        await verificarConclusaoAtividades();

        // Verifica conclusão de atividades periodicamente
        setInterval(verificarConclusaoAtividades, 5000); // Verifica a cada 5 segundos

    } catch (error) {
        console.error('Erro ao executar o código principal:', error);
    }
});





</script>

</html>